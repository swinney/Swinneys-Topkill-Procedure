<?
// $Id$

require_once("./global.inc");

if ($username && $password) {
  // pull user info from the database
  $query = <<<EOT
SELECT user_id, username, password
  FROM user
 WHERE username='$username'
EOT;
#  var_dump($auth_dsn);
  $auth_db = DB::connect($auth_dsn);
  if (DB::isError($auth_db)) {
    die ($auth_db->getMessage());
  }
  $res = $auth_db->query($query);
  $user = $res->fetchRow(DB_FETCHMODE_OBJECT);
  if (DB::isError($user)) {
    die ($user->getMessage());
  }

  // make sure the user exists
  if ($user) {
    // verify the submitted credentials
    if (crypt($password, $user->password) == $user->password) {
    } else {
      $error_msg = "Incorrect password.  Please try again:";
      $error_redirect = "login.phtml";
    }
  } else {
    // username does not exist in the database
    $error_msg =
      "$username is unregistered. <a href=\"submit_register.phtml?username=$username\">Register it now</a>, or try again:";
    $error_redirect = "login.phtml";
  }
} else {
  $error_msg = "Enter both username and password to log in:";
  $error_redirect = "login.phtml";
}

if ($error_msg) {
  session_register("error_msg");
  header("Location: $error_redirect");
  exit;
}

// save some info in the session so other pages can access it later
// in the session
$authenticated_username = $user->username;
session_register("authenticated_username");

$authenticated_user_id = $user->user_id;
session_register("authenticated_user_id");

$bozo_set=get_bozo_set();

// $back_to is the location where the user originally clicked the "log
// in" link
if (!$back_to) {
    $back_to=URLBASE;
}
$auth_db->disconnect();
header ("Location: $back_to");
?>

