<?
#$Id$
require_once("global.inc");

if (!$username || !$password) {
  $login_error_msg = "You must specify both a username and a password.";
  include("login.phtml");
  exit;
}

$res = mysql_query("SELECT username,password FROM user WHERE username='$username'") or
die(error_page(mysql_error()));

$user = mysql_fetch_object($res);
if (!$user) {
  // username does not exist in the database
  $login_error_msg =
    "Sorry, $username but you are going to have to register that.";
  header("Location: submit_register.phtml?username=$username");
  exit;
}

if (crypt($password, $user->password) != $user->password) {
  $login_error_msg = "Password mismatch";
  include("login.phtml");
  exit;
}

// save the username in the session so other pages can access it later
// in the session
$authenticated_username = $user->username;
session_register("authenticated_username");

# $back_to is taken from a hidden form field on
# login.phtml and is derived from $HTTP_REFERER
header("Location: " . $back_to);
?>

