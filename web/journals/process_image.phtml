<?
// $Id$
require_once("global.inc");

if ($submit_image) {
  if ($userfile) {
    if (is_uploaded_file($userfile)) {
      if (ereg("^image/(.+)$", $userfile_type, $matches)) {
        $ext = strtolower($matches[1]);
        if ($ext == "pjpeg") {
          $ext = "jpg";
        }

	if (!isset($index)) {
	  $index = 1;
	} else { 
	  $index++;
	}

        $filename = $article_id . "_" . $index . "." . $ext;

        // Copy the file to our uploads directory
        $destination = IMGBASE . "/$filename";
        if (move_uploaded_file($userfile, $destination)) {
          $query = <<<EOT
UPDATE articles_info
   SET image='$index'
 WHERE article_id='$article_id'
EOT;

          if (mysql_query($query)) {
            // suppress success message.
          } else {
            // XXX: partially committed transaction! how to handle?
            $error_msg = "Error updating database: " . mysql_error();
          }
        } else {
          $error_msg = "Error saving image $userfile to $destination.";
	  // roll back the index since the file wasn't moved
        }
      } else {
        $error_msg = "Non-image file type $userfile_type. Try again.";
      }
    } else {
      $error_msg = "Naughty! That is an invalid filename";
    }
  } else {
    $error_msg = "No file specified. Try again.";
  }

  include("./submit_image.phtml");
} else {
  header("Location: " . URLBASE);
}
?> 
